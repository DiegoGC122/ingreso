import streamlit as st
import sqlite3
import bcrypt
from config import conectar_sqlite

# üîê Validar login con SQLite
def validar_login(correo, password):
    conn = conectar_sqlite()
    try:
        cursor = conn.cursor()
        cursor.execute("SELECT nombre, contrase√±a_hash, rol FROM usuarios WHERE correo = ? AND activo = 1", (correo,))
        resultado = cursor.fetchone()
        conn.close()

        if resultado:
            nombre, password_hash, rol = resultado
            if password_hash and bcrypt.checkpw(password.encode(), password_hash.encode()):
                return nombre  # Si luego quieres usar el rol, puedes devolver {"nombre": nombre, "rol": rol}
    except Exception as e:
        st.error(f"‚ùå Error al validar credenciales: {e}")
    return None

# üñ•Ô∏è Interfaz de login (si se usa como m√≥dulo independiente)
def mostrar_login():
    st.title("üîê Iniciar sesi√≥n")
    correo = st.text_input("Correo BBVA").strip().lower()
    password = st.text_input("Contrase√±a", type="password")

    if st.button("Ingresar"):
        if not correo.endswith("@bbva.com") and not correo.endswith("@bbva.com.co"):
            st.error("‚ùå Solo se permite el correo BBVA.")
            return

        nombre = validar_login(correo, password)
        if nombre:
            st.session_state["usuario_autenticado"] = correo
            st.session_state["nombre_autenticado"] = nombre
            st.rerun()
        else:
            st.error("‚ùå Credenciales incorrectas. Verifica tu correo y contrase√±a.")
